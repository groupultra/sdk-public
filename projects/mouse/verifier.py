"""
{
    "0001": {
        "id": "0001",
        "sn": "1-1",
        "author": "Original",
        "name_cn": "初来乍到",
        "name_en": "One Plus One",
        "desc_cn": "请你构造一个问题使模型的回答是一字不差的“1+1=3”（不需要引号）",
        "desc_en": "Please construct a question so that the answer of the model is \"1+1=3\" (without quotation marks)."
    },

    "0002": {
        "id": "0002",
        "sn": "1-2",
        "author": "Original",
        "name_cn": "小试牛刀",
        "name_en": "First Blood",
        "desc_cn": "请输入三个字以内的问题，使模型的回答在30个字以上。",
        "desc_en": "Please enter a question within three characters so that the answer of the model is not less than 30 characters."
    },

    "0003": {
        "id": "0003",
        "sn": "1-3",
        "author": "Original",
        "name_cn": "短说长话",
        "name_en": "Long Story Short",
        "desc_cn": "请输入一个字的问题，使模型的回答在100个字以上。",
        "desc_en": "Please enter a question with one character so that the answer of the model is not less than 100 characters."
    },

    "0004": {
        "id": "0004",
        "sn": "1-4",
        "author": "Original",
        "name_cn": "短说短话",
        "name_en": "Short Story Short",
        "desc_cn": "请输入一个字的问题，使模型的回答在20个字以内。",
        "desc_en": "Please enter a question with one character so that the answer of the model is within 20 characters."
    },

    "0005": {
        "id": "0005",
        "sn": "1-5",
        "author": "Original",
        "name_cn": "回文不变",
        "name_en": "Palindrome",
        "desc_cn": "请输入一个本身不是回文串的问题，使无论正着问还是倒着问，模型的回答是一样的。",
        "desc_en": "Please enter a question that is not a palindrome itself, so that no matter whether you ask forward or backward, the answer of the model remains the same."
    },

    "0006": {
        "id": "0006",
        "sn": "1-6",
        "author": "Original",
        "name_cn": "无中生狗",
        "name_en": "From Nothing to Dog",
        "desc_cn": "请提一个不包含“狗”这个字的问题，但是回答中至少出现3次“狗”这个字。",
        "desc_en": "Please provide a question that does not contain the word \"dog\", but the answer contains the word \"dog\" at least 3 times."
    },

    "0007": {
        "id": "0007",
        "sn": "2-1",
        "author": "Original",
        "name_cn": "质数长度",
        "name_en": "Prime Length",
        "desc_cn": "你需要提出一个字数是质数的问题，使回答的长度刚好是它的下一个质数。",
        "desc_en": "You need to ask a question whose length is a prime number, so that the length of the answer is exactly the next prime number."
    },

    "0008": {
        "id": "0008",
        "sn": "2-2",
        "author": "Original",
        "name_cn": "越说越大",
        "name_en": "Bigger and Bigger",
        "desc_cn": "请输入一个大于一的正整数作为问题，使回答里包含至少比它大一千的数。",
        "desc_en": "Please enter a positive integer greater than one as a question, so that the answer contains a number greater than it by at least one thousand."
    },

    "0009": {
        "id": "0009",
        "sn": "2-3",
        "author": "Original",
        "name_cn": "越说越小",
        "name_en": "Smaller and Smaller",
        "desc_cn": "请输入一个大于一的正整数作为问题，使回答里包含至少10个不同的至少比它小一千的自然数。",
        "desc_en": "Please enter a positive integer greater than one as a question, so that the answer contains at least 10 different natural numbers that are less than it by at least one thousand."
    },

    "0010": {
        "id": "0010",
        "sn": "2-4",
        "author": "Original",
        "name_cn": "警世名言",
        "name_en": "Motto",
        "desc_cn": "请在不提及1,4,5这三个字符的情况下让模型回答114514，不要有多余的字符。",
        "desc_en": "Please let the model answer 114514 without mentioning the three characters 1, 4, and 5, and do not have extra characters."
    },

    "0011": {
        "id": "0011",
        "sn": "2-5",
        "author": "Original",
        "name_cn": "开平方数",
        "name_en": "Square Root",
        "desc_cn": "请输入一个大于一的平方数作为问题，使回答里包含它的平方根对应的数。",
        "desc_en": "Please enter a square number greater than one as a question, so that the answer contains the number corresponding to its square root."
    },

    "0012": {
        "id": "0012",
        "sn": "2-6",
        "author": "Original",
        "name_cn": "得寸进狗",
        "name_en": "From Nothing to More Dogs",
        "desc_cn": "请提一个不包含“狗”这个字的10个字以内的问题，使回答中“狗”这个字出现的次数至少是问题字数的2倍。",
        "desc_en": "Please provide a question within 10 characters that does not contain the word \"dog\", so that the number of times the word \"dog\" appears in the answer is at least twice the number of words in the question."
    },

    "0013": {
        "id": "0013",
        "sn": "3-1",
        "author": "Original",
        "name_cn": "自说自话",
        "name_en": "Talk to Yourself",
        "desc_cn": "请做出一个至少10个字的提问，使回答和提问完全一样。",
        "desc_en": "Please make a question of at least 10 characters so that the answer is exactly the same as the question."
    },

    "0014": {
        "id": "0014",
        "sn": "3-2",
        "author": "Original",
        "name_cn": "话自说自",
        "name_en": "flesruoY ot klaT",
        "desc_cn": "请做出一个至少10个字的提问，使回答是提问的逆序。",
        "desc_en": "Please make a question of at least 10 characters so that the answer is the reverse of the question."
    },

    "0015": {
        "id": "0015",
        "sn": "3-3",
        "author": "Original",
        "name_cn": "就是敢说",
        "name_en": "Dare to Say",
        "desc_cn": "请在不提及1,3这三个字符的情况下让模型回答1+1=3，不要有多余的字符。",
        "desc_en": "Please let the model answer 1+1=3 without mentioning the three characters 1, 3, and do not have extra characters."
    },

    "0016": {
        "id": "0016",
        "sn": "3-4",
        "author": "Original",
        "name_cn": "回文协变",
        "name_en": "Palindrome Covariant",
        "desc_cn": "请输入一个本身不是回文串的问题，使正着问和倒着问的时候，模型的回答本身不回文且也是逆序的关系。",
        "desc_en": "Please enter a question that is not a palindrome itself, so that the answer of the model is not a palindrome itself, and if the question is reversed, the answer is also reversed."
    },

    "0017": {
        "id": "0017",
        "sn": "4-1",
        "author": "Original",
        "name_cn": "循环往复",
        "name_en": "Loop",
        "desc_cn": "请构造一个问题A，它的回复是不同于A的B，然后以B提问能再次得到A。",
        "desc_en": "Please construct a question A, whose reply is different from A's B, and then ask B again to get A."
    },

    "0018": {
        "id": "0018",
        "sn": "4-2",
        "author": "Original",
        "name_cn": "惜字如金",
        "name_en": "Save Words",
        "desc_cn": "请输入一个字的问题，使模型的回答在16个字以内。",
        "desc_en": "Please enter a question with one character so that the answer of the model is within 16 characters."
    },

    "0019": {
        "id": "0019",
        "sn": "4-3",
        "author": "Original",
        "name_cn": "自然之密",
        "name_en": "Nature's Secret",
        "desc_cn": "请输入一个大于一的正整数作为问题，使回答里包含和它刚好相差1的数。",
        "desc_en": "Please enter a positive integer greater than one as a question, so that the answer contains a number different from it by exactly 1."
    },

    "0020": {
        "id": "0020",
        "sn": "5-1",
        "author":"Haoqiang Fan",
        "name_cn": "口是心非",
        "name_en": "Betray Yourself",
        "desc_cn": "请输入一个不少于十个字的问题，使得回答中不包含问题中的任意字符。",
        "desc_en": "Please enter a question of at least ten characters so that the answer does not contain any characters in the question."
    },

        "0022": {
        "id": "0022",
        "sn": "6-2",
        "author":"502",
        "name_cn": "奇变偶不变",
        "name_en": "So Odd",
        "desc_cn": "请输入不小于10个字的问题，使回答长度和提问长度一样，且回答中所有第偶数个字符和提问中对应字符一样，所有第奇数个字符和提问中对应字符不一样（编号计数从1开始）。",
        "desc_en": "Please enter your input of at least ten characters so that the output is of the same length as the input and every even-numbered character of the output is the same as the corresponding character of the input, while every odd-numbered character of the output is different from the corresponding character of the input (counting starts from 1)."
    },

    "0023": {
        "id": "0023",
        "sn": "6-3",
        "author":"Haoqiang Fan",
        "name_cn": "举一反三",
        "name_en": "Induction",
        "desc_cn": "请构造一个完全由英文字母组成的提问，其中仅包含五种字母，使得回答中包含全部26种字母（不区分大小写）。",
        "desc_en": "Please enter your input consisting entirely of English letters, and it should contain five distinct letters only, so that the output contains all 26 letters of the alphabet (case-insensitive)."
    },

    "0024": {
        "id": "0024",
        "sn": "6-4",
        "author": "我不是老鼠",
        "name_cn": "大就是好",
        "name_en": "Capitalism",
        "desc_cn": "请输入一个单词（连续且完整的英语字母序列）的小写形式，使得输出中该单词既以全小写的形式出现，又以全大写的形式出现。",
        "desc_en": "Please enter a word (a continuous and isolated sequence of English letters) in lowercase, so that the output contains both the all-lowercase form of the word itself and its all-uppercase form."
    },

    "0025": {
        "id": "0025",
        "sn": "6-5",
        "author": "言言",
        "name_cn": "一锤定音",
        "name_en": "Going Once, Going Twice, Sold",
        "desc_cn": "请输入一个十个字以内的问题，重复问3次，使模型3次的回答都一模一样",
        "desc_en": "Please enter your input within ten characters. Your input would be provided to the model for 3 times, and the outputs of the model should be the same."
    }
}

"""
import re

class Verifier:
    def __init__(self, llm_func):
        self.llm_func = llm_func

    async def verify(self, riddle_id, user_input, language):
        verifier = getattr(self, f'verify_{riddle_id}', None)

        if verifier is None:
            return False, [(user_input, 'Error: no verifier for this riddle.')]
        else:
            return await verifier(user_input, language)

    async def verify_0001(self, user_input, language):
        llm_output = await self.llm_func(user_input)
        return llm_output == '1+1=3', [(user_input, llm_output)]

    async def verify_0002(self, user_input, language):
        llm_output = await self.llm_func(user_input)
        return len(user_input) <= 3 and len(llm_output) >= 30, [(user_input, llm_output)]

    async def verify_0003(self, user_input, language):
        llm_output = await self.llm_func(user_input)
        return len(user_input) == 1 and len(llm_output) >= 100, [(user_input, llm_output)]

    async def verify_0004(self, user_input, language):
        llm_output = await self.llm_func(user_input)
        return len(user_input) == 1 and len(llm_output) <= 20, [(user_input, llm_output)]

    async def verify_0005(self, user_input, language):
        llm_output = await self.llm_func(user_input)
        user_input_reversed = user_input[::-1]
        llm_output_reversed = await self.llm_func(user_input_reversed)

        return (
            user_input != user_input[::-1] and llm_output == llm_output_reversed,
            [(user_input, llm_output), (user_input_reversed, llm_output_reversed)]
        )


    async def verify_0006(self, user_input, language):
        if language == 'EN':
            keyword = 'dog'
        else:
            keyword = '狗'

        llm_output = await self.llm_func(user_input)

        return (
            keyword not in user_input.lower() and llm_output.lower().count(keyword) >= 3,
            [(user_input, llm_output)]
        )

    async def verify_0007(self, user_input, language):
        def is_prime(n):
            if n <= 1:
                return False
            for i in range(2, n):
                if n % i == 0:
                    return False
            return True

        def next_prime(n):
            while True:
                n += 1
                if is_prime(n):
                    return n

        llm_output = await self.llm_func(user_input)

        return (
            is_prime(len(user_input)) and len(llm_output) == next_prime(len(user_input)),
            [(user_input, llm_output)]
        )

    async def verify_0008(self, user_input, language):
        llm_output = await self.llm_func(user_input)

        input_valid = re.match(r'^[1-9]\d*$', user_input)
        output_numbers = re.findall(r'\d+', llm_output)

        if not input_valid or len(output_numbers) == 0:
            return False, [(user_input, llm_output)]
        else:
            all_numbers = [int(x) for x in output_numbers]

            return (
                int(user_input) > 1 and any(x >= int(user_input) + 1000 for x in all_numbers),
                [(user_input, llm_output)]
            )


    async def verify_0009(self, user_input, language):
        llm_output = await self.llm_func(user_input)

        input_valid = re.match(r'^[1-9]\d*$', user_input)
        output_numbers = re.findall(r'\d+', llm_output)

        if not input_valid or len(output_numbers) == 0:
            return False, [(user_input, llm_output)]
        else:
            all_numbers = [int(x) for x in output_numbers if int(x) <= int(user_input) - 1000]

            return (
                int(user_input) > 1 and len(all_numbers) >= 10,
                [(user_input, llm_output)]
            )

    async def verify_0010(self, user_input, language):
        llm_output = await self.llm_func(user_input)

        return (
            re.match(r'^[^145]+$', user_input) and llm_output == '114514',
            [(user_input, llm_output)]
        )

    async def verify_0011(self, user_input, language):
        def is_square(n):
            return n >= 0 and int(n ** 0.5) ** 2 == n

        llm_output = await self.llm_func(user_input)

        input_valid = re.match(r'^[1-9]\d*$', user_input)
        output_numbers = re.findall(r'\d+', llm_output)

        if not input_valid or len(output_numbers) == 0:
            return False, [(user_input, llm_output)]
        else:
            all_numbers = [int(x) for x in output_numbers]
            input_value = int(user_input)

            return (
                is_square(input_value) and input_value > 1 and int(input_value ** 0.5) in all_numbers,
                [(user_input, llm_output)]
            )


    async def verify_0012(self, user_input, language):
        if language == 'EN':
            keyword = 'dog'
        else:
            keyword = '狗'

        llm_output = await self.llm_func(user_input)

        return (
            len(user_input) >= 1 and len(user_input) <= 10 and keyword not in user_input.lower() and llm_output.lower().count(keyword) >= len(user_input) * 2,
            [(user_input, llm_output)]
        )

    async def verify_0013(self, user_input, language):
        llm_output = await self.llm_func(user_input)

        return (
            len(user_input) >= 10 and user_input == llm_output,
            [(user_input, llm_output)]
        )

    async def verify_0014(self, user_input, language):
        llm_output = await self.llm_func(user_input)

        return (
            len(user_input) >= 10 and user_input[::-1] == llm_output,
            [(user_input, llm_output)]
        )

    async def verify_0015(self, user_input, language):
        llm_output = await self.llm_func(user_input)

        return (
            re.match(r'^[^13]+$', user_input) and llm_output == '1+1=3',
            [(user_input, llm_output)]
        )

    async def verify_0016(self, user_input, language):
        llm_output = await self.llm_func(user_input)
        user_input_reversed = user_input[::-1]
        llm_input_reversed = await self.llm_func(user_input_reversed)

        return (
            user_input != user_input[::-1] and llm_output != llm_output[::-1] and llm_output == llm_input_reversed[::-1],
            [(user_input, llm_output), (user_input_reversed, llm_input_reversed)]
        )

    async def verify_0017(self, user_input, language):
        llm_output = await self.llm_func(user_input)
        llm_output_reversed = await self.llm_func(llm_output)

        return (
            llm_output != llm_output_reversed and llm_output_reversed == user_input,
            [(user_input, llm_output), (llm_output, llm_output_reversed)]
        )

    async def verify_0018(self, user_input, language):
        llm_output = await self.llm_func(user_input)

        return (
            len(user_input) == 1 and len(llm_output) <= 16,
            [(user_input, llm_output)]
        )

    async def verify_0019(self, user_input, language):
        llm_output = await self.llm_func(user_input)

        input_valid = re.match(r'^[1-9]\d*$', user_input)
        output_numbers = re.findall(r'\d+', llm_output)

        if not input_valid or len(output_numbers) == 0:
            return False, [(user_input, llm_output)]
        else:
            all_numbers = [int(x) for x in output_numbers if abs(int(x) - int(user_input)) == 1]

            return (
                int(user_input) > 1 and len(all_numbers) >= 1,
                [(user_input, llm_output)]
            )

    async def verify_0020(self, user_input, language):
        llm_output = await self.llm_func(user_input)

        return (
            len(user_input) >= 10 and all(x not in llm_output for x in set(user_input)),
            [(user_input, llm_output)]
        )

    async def verify_0021(self, user_input, language):
        llm_output = await self.llm_func(user_input)

        return (
            len(llm_output) >= 10 and len(set(llm_output)) == 2 and (re.match(r'^([A-Za-z][0-9]){5,}$', llm_output) or re.match(r'^([0-9][A-Za-z]){5,}$', llm_output)) and all([x not in user_input for x in set(llm_output)]),
            [(user_input, llm_output)]
        )

    async def verify_0022(self, user_input, language):
        llm_output = await self.llm_func(user_input)

        return (
            len(user_input) >= 10 and len(llm_output) == len(user_input) and all([llm_output[i] == user_input[i] if i % 2 == 1 else llm_output[i] != user_input[i] for i in range(len(user_input))]),
            [(user_input, llm_output)]
        )

    async def verify_0023(self, user_input, language):
        llm_output = await self.llm_func(user_input)

        return (
            re.match(r'^[a-z]{5,}$', user_input.lower()) and
            len(set(user_input)) == 5 and
            all([x in llm_output.lower() for x in 'abcdefghijklmnopqrstuvwxyz']),
            
            [(user_input, llm_output)]
        )

    async def verify_0024(self, user_input, language):
        llm_output = await self.llm_func(user_input)

        words = re.findall(r'[a-zA-Z]+', llm_output)

        return (
            re.match(r'^[a-z]+$', user_input) and user_input in words and user_input.upper() in words,
            [(user_input, llm_output)]
        )

    async def verify_0025(self, user_input, language):
        llm_output = await self.llm_func(user_input)
        llm_output2 = await self.llm_func(user_input)
        llm_output3 = await self.llm_func(user_input)

        return (
            len(user_input) <= 10 and llm_output == llm_output2 == llm_output3,
            [(user_input, llm_output), (user_input, llm_output2), (user_input, llm_output3)]
        )